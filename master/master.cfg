from buildbot.buildslave import BuildSlave
from buildbot.changes.gitpoller import GitPoller
from buildbot.schedulers.basic import SingleBranchScheduler
from buildbot.schedulers.forcesched import ForceScheduler
from buildbot.changes import filter
from buildbot.process.factory import BuildFactory
from buildbot.steps.source.git import Git
from buildbot.steps.shell import ShellCommand
from buildbot.config import BuilderConfig
from buildbot.status import html
from buildbot.status.web import authz, auth

rethinkdb_git = 'git://github.com/rethinkdb/rethinkdb'

slaves = [BuildSlave("example-slave", "pass")]

protocols = {'pb': {'port': 9989}}

change_source = [
    GitPoller(
        rethinkdb_git,
        workdir='gitpoller-workdir', branch='next',
        pollinterval=300
    )
]

schedulers = [
    SingleBranchScheduler(
        name="all",
        change_filter=filter.ChangeFilter(branch='master'),
        treeStableTimer=None,
        builderNames=["runtests"]
    ),
    ForceScheduler(
        name="force",
        builderNames=["runtests"]
    )
]

runtests_steps = [
    Git(repourl=rethinkdb_git, mode='incremental'),
    ShellCommand(command=["make"])
]

builders = [
    BuilderConfig(
        name="runtests",
        slavenames=["example-slave"],
        factory=BuildFactory(runtests_steps)
    )
]

authz_cfg = authz.Authz(
    auth=auth.BasicAuth([("rethinkdb","wontonsoup")]),
    gracefulShutdown = 'auth',
    forceBuild = 'auth',
    forceAllBuilds = False,
    pingBuilder = False,
    stopBuild = 'auth',
    stopAllBuilds = 'auth',
    cancelPendingBuild = 'auth'
)

status = [
    html.WebStatus(http_port=8010, authz=authz_cfg)
]

BuildmasterConfig = {
    'slaves': slaves,
    'protocols': protocols,
    'change_source': change_source,
    'schedulers': schedulers,
    'builders': builders,
    'status': status,

    'title': "RethinkDB",
    'titleURL': "http://rethinkdb.com/",
    'buildbotURL': "http://newton:8010/",
    'db': { 'db_url' : "sqlite:///state.sqlite" }
}
